<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VPL Admin Panel â€“ Update Scores</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
/* Base Styles */
body { 
    font-family: 'Inter', Arial, sans-serif; 
    padding: 20px; 
    max-width: 800px; 
    margin: 0 auto; /* Center the container */
    background: #f0f2f5; 
    color: #333;
}
h2, h3 { 
    text-align: center; 
    margin-bottom: 20px; 
    color: #004d99;
}
.box { 
    background: white; 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    margin-bottom: 30px; 
    border-top: 5px solid #007bff;
}
label { 
    font-weight: 600; 
    margin-top: 10px; 
    display: block; 
    color: #555;
}
input, select { 
    width: 100%; 
    padding: 12px; 
    margin: 5px 0 15px; 
    border-radius: 8px; 
    border: 1px solid #ccc; 
    box-sizing: border-box;
    transition: border-color 0.3s;
}
input:focus, select:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
}
button { 
    width: 100%; 
    padding: 14px; 
    background: #28a745; 
    color: white; 
    border: none; 
    border-radius: 8px; 
    font-size: 16px; 
    cursor: pointer; 
    margin-top: 10px; 
    transition: background 0.3s, transform 0.1s;
    box-shadow: 0 4px #1e7e34;
}
button:hover { 
    background: #218838; 
}
button:active {
    transform: translateY(2px);
    box-shadow: 0 2px #1e7e34;
}
.update-team-btn {
    background: #007bff;
    box-shadow: 0 4px #0056b3;
}
.update-team-btn:hover {
    background: #0069d9;
}
.update-team-btn:active {
    box-shadow: 0 2px #0056b3;
}

.player-section { 
    border: 1px solid #e0e0e0; 
    padding: 15px; 
    border-radius: 8px; 
    margin-bottom: 20px; 
    background: #fafafa;
}

/* Notification Box Styling */
#notification-box {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    min-width: 300px;
    padding: 15px 25px;
    background-color: #333;
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    opacity: 0;
    transition: opacity 0.5s, transform 0.5s;
    z-index: 1000;
    text-align: center;
}
.notification-active {
    opacity: 1 !important;
    transform: translateX(-50%) translateY(0) !important;
}

/* Confirmation Modal Styling */
#confirmation-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none; /* Hidden by default */
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
.modal-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    min-width: 300px;
    max-width: 90%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.modal-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 20px;
}
.modal-actions button {
    width: 48%;
    padding: 10px;
    margin: 0;
}
.modal-confirm {
    background: #dc3545;
    box-shadow: 0 4px #a71d2a;
}
.modal-confirm:hover {
    background: #c82333;
}
.modal-cancel {
    background: #6c757d;
    box-shadow: 0 4px #545b62;
}
.modal-cancel:hover {
    background: #5a6268;
}
</style>
</head>
<body>

<div id="notification-box"></div>

<div id="confirmation-modal">
    <div class="modal-content">
        <p id="confirmation-message">Are you sure you want to perform this action?</p>
        <div class="modal-actions">
            <button id="modal-confirm-btn" class="modal-confirm">Confirm</button>
            <button id="modal-cancel-btn" class="modal-cancel">Cancel</button>
        </div>
    </div>
</div>

<div class="box">
    <h2>VPL Scoreboard Admin</h2>

    <label>Match Status:</label>
    <select id="match-status">
        <option value="LIVE">LIVE</option>
        <option value="FINAL">FINAL</option>
        <option value="INNINGS BREAK">INNINGS BREAK</option>
    </select>

    <h3>Team Scores</h3>
    <label>RCB Score (e.g., 120/3):</label>
    <input type="text" id="rcb-score" placeholder="e.g., 120/3">

    <label>RCB Overs (e.g., 12.4):</label>
    <input type="text" id="rcb-overs" placeholder="e.g., 12.4">

    <label>PBKS Score (e.g., 110/5):</label>
    <input type="text" id="pbks-score" placeholder="e.g., 110/5">

    <label>PBKS Overs (e.g., 11.3):</label>
    <input type="text" id="pbks-overs" placeholder="e.g., 11.3">

    <button onclick="updateTeam()" class="update-team-btn">Update Team Scores</button>
</div>

<div class="box">
    <h3>Current Bowler Stats (Live Ticker)</h3>
    <div id="bowler-section" class="player-section">
        <label>Bowler Name:</label>
        <input type="text" id="bowler-name" placeholder="Bowler's Name">
        <label>Overs:</label>
        <input type="text" id="bowler-overs" placeholder="e.g., 3.2">
        <label>Maidens:</label>
        <input type="number" id="bowler-maidens" placeholder="e.g., 0">
        <label>Runs Conceded:</label>
        <input type="number" id="bowler-runs-conceded" placeholder="e.g., 25">
        <label>Wickets:</label>
        <input type="number" id="bowler-wickets" placeholder="e.g., 2">
        <label>Economy (For display only):</label>
        <input type="text" id="bowler-economy" placeholder="e.g., 7.81">
        
        <button onclick="updateBowler()" class="update-team-btn">Update Live Bowler Stats</button>
    </div>
</div>

<div class="box">
    <h3>Live Ball-by-Ball Score Update</h3>
    <p>Select score type and press 'Update Live Score'</p>

    <label>Batting Team (for score logic):</label>
    <select id="batting-team">
        <option value="rcb">RCB</option>
        <option value="pbks">PBKS</option>
    </select>
    
    <label>Live Score Type:</label>
    <select id="score-type">
        <option value="1">1 Run</option>
        <option value="2">2 Runs</option>
        <option value="3">3 Runs</option>
        <option value="4">4 Runs</option>
        <option value="6">6 Runs</option>
        <option value="W">Wicket (Dismissal)</option>
        <option value="WD">Wide (1 Run Extra)</option>
        <option value="NB">No Ball (1 Run Extra)</option>
        <option value="LB">Leg Bye (No Ball Count)</option>
        <option value="B">Bye (No Ball Count)</option>
        <option value="0">Dot Ball</option>
    </select>

    <label>Extra Runs (e.g., Wide with 2 extra runs):</label>
    <input type="number" id="extra-runs" value="0" min="0">

    <button onclick="updateLiveScore()" class="update-team-btn">Update Live Score</button>
    <button onclick="undoLastBall()" class="modal-cancel">Undo Last Ball</button>
</div>
<div class="box">
    <h3>RCB Bowlers Scorecard (Persistent Data)</h3>
    <div id="rcb-bowlers-scorecard">
        </div>
    <button onclick="addBowlerToScorecard('rcb_bowlers')">Add RCB Bowler to Scorecard</button>
</div>

<div class="box">
    <h3>PBKS Bowlers Scorecard (Persistent Data)</h3>
    <div id="pbks-bowlers-scorecard">
        </div>
    <button onclick="addBowlerToScorecard('pbks_bowlers')">Add PBKS Bowler to Scorecard</button>
</div>


<div class="box">
    <h3>RCB Players (Batting/Dismissed)</h3>
    <div id="rcb-players"></div>
    <button onclick="addRCBPlayer()">Add RCB Player</button>
</div>

<div class="box">
    <h3>PBKS Players (Batting/Dismissed)</h3>
    <div id="pbks-players"></div>
    <button onclick="addPBKSPlayer()">Add PBKS Player</button>
</div>

<script>
// IMPORTANT: Replace with your actual Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyAgRNYcERmBBYfQcXF0PQA5P-Ifqo6O3to",
    authDomain: "vpl2025-71c32.firebaseapp.com",
    databaseURL: "https://vpl2025-71c32-default-rtdb.firebaseio.com/",
    projectId: "vpl2025-71c32",
    storageBucket: "vpl2025-71c32.firebasestorage.app",
    messagingSenderId: "239331513898",
    appId: "1:239331513898:web:1b0179c03591f6de7a1553"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const matchRef = db.ref("vpl2025/match2");

// --- UTILITY FUNCTIONS (Custom Alert/Confirm) ---

function showMessage(message) {
    const box = document.getElementById("notification-box");
    box.textContent = message;
    box.classList.add("notification-active");
    setTimeout(() => {
        box.classList.remove("notification-active");
    }, 3000);
}

function showConfirmation(message, onConfirm) {
    const modal = document.getElementById('confirmation-modal');
    const msgElement = document.getElementById('confirmation-message');
    const confirmBtn = document.getElementById('modal-confirm-btn');
    const cancelBtn = document.getElementById('modal-cancel-btn');

    msgElement.textContent = message;
    modal.style.display = 'flex'; 

    confirmBtn.onclick = null;
    cancelBtn.onclick = null;

    confirmBtn.onclick = () => {
        modal.style.display = 'none';
        onConfirm();
    };

    cancelBtn.onclick = () => {
        modal.style.display = 'none';
    };
}

// --- LIVE SCORING FUNCTIONS (NEW) ---

// Function to convert overs from X.Y to total balls (for calculation)
function oversToBalls(oversStr) {
    const [main, balls] = oversStr.split('.');
    return (Number(main) * 6) + Number(balls || 0);
}

// Function to convert total balls to overs in X.Y format (for display)
function ballsToOvers(totalBalls) {
    const overs = Math.floor(totalBalls / 6);
    const balls = totalBalls % 6;
    return `${overs}.${balls}`;
}

function updateLiveScore() {
    const team = document.getElementById("batting-team").value;
    const scoreType = document.getElementById("score-type").value;
    const extraRuns = Number(document.getElementById("extra-runs").value);

    // Get the current score data from Firebase to update it atomically
    matchRef.once('value')
        .then(snapshot => {
            const data = snapshot.val();
            if (!data) throw new Error("Match data not found.");

            // Determine which team's score/overs to update
            const teamScoreKey = `${team}Score`;
            const teamOversKey = `${team}Overs`;

            // Parse current score/overs
            const currentScoreStr = data[teamScoreKey] || "0/0";
            const currentOversStr = data[teamOversKey] || "0.0";
            let [currentRuns, currentWickets] = currentScoreStr.split('/').map(Number);
            let totalBalls = oversToBalls(currentOversStr);
            let runsScored = 0;
            let ballsDelivered = 0;
            let wicketsLost = 0;

            const isExtra = ['WD', 'NB', 'LB', 'B'].includes(scoreType);
            const isNoBallOrWide = ['WD', 'NB'].includes(scoreType);
            const isWicket = scoreType === 'W';

            // 1. Calculate the score increments based on scoreType
            if (isWicket) {
                wicketsLost = 1;
                ballsDelivered = 1;
            } else if (isExtra) {
                // Wide or No Ball: 1 run + extra runs + ball not counted
                if (isNoBallOrWide) {
                    runsScored = 1 + extraRuns;
                    ballsDelivered = 0; // Does not count as a ball
                }
                // Leg Bye or Bye: Extra runs (from input field) + ball counted
                else { 
                    runsScored = extraRuns; // Runs go to extras, not to batsman
                    ballsDelivered = 1; // Counts as a ball
                }
            } else {
                // Legitimate runs (0, 1, 2, 3, 4, 6)
                runsScored = Number(scoreType);
                ballsDelivered = 1;
            }

            // 2. Update Total Score
            currentRuns += runsScored;
            currentWickets += wicketsLost;
            totalBalls += ballsDelivered;

            // 3. Prepare the new data object
            const newScoreStr = `${currentRuns}/${currentWickets}`;
            const newOversStr = ballsToOvers(totalBalls);
            
            const updates = {
                [teamScoreKey]: newScoreStr,
                [teamOversKey]: newOversStr,
                // New field to store the last ball for undo
                lastBall: {
                    team,
                    scoreType,
                    runsScored,
                    ballsDelivered,
                    wicketsLost,
                    prevScoreStr: currentScoreStr,
                    prevOversStr: currentOversStr
                }
            };
            
            // 4. Update Firebase
            return matchRef.update(updates);
        })
        .then(() => {
            showMessage("Live Score updated successfully!");
            document.getElementById("extra-runs").value = 0; // Reset extra runs
        })
        .catch(error => {
            showMessage("Error updating live score: " + error.message);
        });
}

function undoLastBall() {
    showConfirmation("Are you sure you want to UNDO the last ball? This action cannot be reversed.", () => {
        matchRef.once('value')
            .then(snapshot => {
                const data = snapshot.val();
                if (!data || !data.lastBall) throw new Error("No last ball data found to undo.");

                const lastBall = data.lastBall;
                const team = lastBall.team;
                const teamScoreKey = `${team}Score`;
                const teamOversKey = `${team}Overs`;

                // Restore previous state
                const updates = {
                    [teamScoreKey]: lastBall.prevScoreStr,
                    [teamOversKey]: lastBall.prevOversStr,
                    // Remove the lastBall record after undoing
                    lastBall: null 
                };

                return matchRef.update(updates);
            })
            .then(() => {
                showMessage("Last ball undone successfully!");
            })
            .catch(error => {
                showMessage("Error undoing last ball: " + error.message);
            });
    });
}

// --- LIVE BOWLER FUNCTIONS ---

function updateBowler() {
    const name = document.getElementById("bowler-name").value;
    const overs = document.getElementById("bowler-overs").value;
    const maidens = Number(document.getElementById("bowler-maidens").value);
    const runsConceded = Number(document.getElementById("bowler-runs-conceded").value);
    const wickets = Number(document.getElementById("bowler-wickets").value);
    const economy = document.getElementById("bowler-economy").value;

    const bowlerData = {
        name,
        overs,
        maidens,
        runsConceded,
        wickets,
        economy
    };

    matchRef.child("currentBowler").set(bowlerData)
        .then(() => {
            showMessage("Live Bowler stats updated successfully!");
        })
        .catch(error => {
            showMessage("Error updating live bowler: " + error.message);
        });
}

// --- BOWLER SCORECARD FUNCTIONS (NEW) ---

function createBowlerInput(team, bowlerKey, bowlerData) {
    const div = document.createElement("div");
    div.className = "player-section";
    // Team ID is used here: rcb_bowlers-key or pbks_bowlers-key
    div.id = `${team}-${bowlerKey}`; 

    div.innerHTML = `
        <label>Bowler Name:</label>
        <input type="text" placeholder="Name" value="${bowlerData.name || ''}" class="bowler-name">
        <label>Overs (X.Y):</label>
        <input type="text" placeholder="e.g., 4.0 or 3.2" value="${bowlerData.overs || '0.0'}" class="bowler-overs">
        <label>Maidens:</label>
        <input type="number" placeholder="Maidens" value="${bowlerData.maidens || 0}" class="bowler-maidens">
        <label>Runs Conceded:</label>
        <input type="number" placeholder="Runs" value="${bowlerData.runsConceded || 0}" class="bowler-runsConceded">
        <label>Wickets:</label>
        <input type="number" placeholder="Wickets" value="${bowlerData.wickets || 0}" class="bowler-wickets">
        <button onclick="saveBowler('${team}','${bowlerKey}')">Save Bowler</button>
        <button onclick="requestRemoveBowler('${team}','${bowlerKey}')" class="modal-confirm">Remove Bowler</button>
    `;
    return div;
}

function addBowlerToScorecard(team) {
    // Pushes a new entry to the respective bowling array (rcb_bowlers or pbks_bowlers)
    const newKey = matchRef.child(team).push().key; 
    const containerId = team.includes('rcb') ? "rcb-bowlers-scorecard" : "pbks-bowlers-scorecard";
    const container = document.getElementById(containerId);
    container.appendChild(createBowlerInput(team, newKey, {}));
    showMessage(`New bowler added for ${team.toUpperCase().replace('_BOWLERS', '')}`);
}

function saveBowler(team, key) {
    const div = document.getElementById(`${team}-${key}`);
    const oversInput = div.querySelector(".bowler-overs").value;

    const bowler = {
        name: div.querySelector(".bowler-name").value,
        overs: oversInput,
        maidens: Number(div.querySelector(".bowler-maidens").value),
        runsConceded: Number(div.querySelector(".bowler-runsConceded").value),
        wickets: Number(div.querySelector(".bowler-wickets").value)
    };
    
    matchRef.child(team).child(key).set(bowler)
        .then(() => {
            showMessage(`Bowler ${bowler.name} stats saved!`);
        })
        .catch(error => {
            showMessage("Error saving bowler: " + error.message);
        });
}

function requestRemoveBowler(team, key) {
    showConfirmation("Are you sure you want to permanently remove this bowler from the scorecard?", () => {
        removeBowler(team, key);
    });
}

function removeBowler(team, key) {
    matchRef.child(team).child(key).remove()
        .then(() => {
            const element = document.getElementById(`${team}-${key}`);
            if(element) element.remove();
            showMessage("Bowler removed successfully!");
        })
        .catch(error => {
            showMessage("Error removing bowler: " + error.message);
        });
}


// --- TEAM SCORE FUNCTIONS ---

function updateTeam() {
    const rcbScore = document.getElementById("rcb-score").value;
    const rcbOvers = document.getElementById("rcb-overs").value;
    const pbksScore = document.getElementById("pbks-score").value;
    const pbksOvers = document.getElementById("pbks-overs").value;
    const status = document.getElementById("match-status").value;

    matchRef.update({
        rcbScore, rcbOvers, pbksScore, pbksOvers, status
    })
    .then(() => {
        showMessage("Team scores updated!");
    })
    .catch(error => {
        showMessage("Error updating team scores: " + error.message);
    });
}

// --- PLAYER FUNCTIONS (Batters) ---

function createPlayerInput(team, playerKey, playerData) {
    const div = document.createElement("div");
    div.className = "player-section";
    div.id = `${team}-${playerKey}`;

    div.innerHTML = `
        <label>Player Name:</label>
        <input type="text" placeholder="Name" value="${playerData.name || ''}" class="player-name">
        <label>Runs:</label>
        <input type="number" placeholder="Runs" value="${playerData.runs || 0}" class="player-runs">
        <label>Balls:</label>
        <input type="number" placeholder="Balls" value="${playerData.balls || 0}" class="player-balls">
        <label>4s:</label>
        <input type="number" placeholder="Fours" value="${playerData.fours || 0}" class="player-fours">
        <label>6s:</label>
        <input type="number" placeholder="Sixes" value="${playerData.sixes || 0}" class="player-sixes">
        <label>Strike Rate:</label>
        <input type="text" placeholder="SR (Calculated)" value="${playerData.sr || ''}" class="player-sr" readonly>
        <button onclick="savePlayer('${team}','${playerKey}')">Save Player</button>
        <button onclick="requestRemovePlayer('${team}','${playerKey}')" class="modal-confirm">Remove Player</button>
    `;

    const runsInput = div.querySelector(".player-runs");
    const ballsInput = div.querySelector(".player-balls");
    const srInput = div.querySelector(".player-sr");

    const calculateSR = () => {
        const runs = Number(runsInput.value);
        const balls = Number(ballsInput.value);
        if (balls > 0) {
            srInput.value = ((runs / balls) * 100).toFixed(2);
        } else {
            srInput.value = '0.00';
        }
    };
    runsInput.addEventListener('input', calculateSR);
    ballsInput.addEventListener('input', calculateSR);
    calculateSR();

    return div;
}

function addRCBPlayer() {
    const newKey = matchRef.child("rcbPlayers").push().key;
    const container = document.getElementById("rcb-players");
    container.appendChild(createPlayerInput("rcbPlayers", newKey, {}));
}
function addPBKSPlayer() {
    const newKey = matchRef.child("pbksPlayers").push().key;
    const container = document.getElementById("pbks-players");
    container.appendChild(createPlayerInput("pbksPlayers", newKey, {}));
}

function savePlayer(team, key) {
    const div = document.getElementById(`${team}-${key}`);
    const player = {
        name: div.querySelector(".player-name").value,
        runs: Number(div.querySelector(".player-runs").value),
        balls: Number(div.querySelector(".player-balls").value),
        fours: Number(div.querySelector(".player-fours").value),
        sixes: Number(div.querySelector(".player-sixes").value),
        sr: div.querySelector(".player-sr").value
    };
    
    matchRef.child(team).child(key).set(player)
        .then(() => {
            showMessage(`Player ${player.name} saved!`);
        })
        .catch(error => {
            showMessage("Error saving player: " + error.message);
        });
}

function requestRemovePlayer(team, key) {
    showConfirmation("Are you sure you want to permanently remove this player?", () => {
        removePlayer(team, key);
    });
}

function removePlayer(team, key) {
    matchRef.child(team).child(key).remove()
        .then(() => {
            const element = document.getElementById(`${team}-${key}`);
            if(element) element.remove();
            showMessage("Player removed successfully!");
        })
        .catch(error => {
            showMessage("Error removing player: " + error.message);
        });
}

// --- REALTIME DATA LISTENER (UPDATED) ---

matchRef.on("value", snapshot => {
    const data = snapshot.val();
    if(!data) return;

    // 1. Load Current Bowler Data
    const bowlerData = data.currentBowler || {};
    document.getElementById("bowler-name").value = bowlerData.name || "";
    document.getElementById("bowler-overs").value = bowlerData.overs || "0.0";
    document.getElementById("bowler-maidens").value = bowlerData.maidens || 0;
    document.getElementById("bowler-runs-conceded").value = bowlerData.runsConceded || 0;
    document.getElementById("bowler-wickets").value = bowlerData.wickets || 0;
    document.getElementById("bowler-economy").value = bowlerData.economy || "0.00";

    // 2. Load Batsmen Data (RCB)
    const rcbContainer = document.getElementById("rcb-players");
    rcbContainer.innerHTML = "";
    if(data.rcbPlayers){
        Object.keys(data.rcbPlayers).forEach(key=>{
            rcbContainer.appendChild(createPlayerInput("rcbPlayers", key, data.rcbPlayers[key]));
        });
    }

    // 3. Load Batsmen Data (PBKS)
    const pbksContainer = document.getElementById("pbks-players");
    pbksContainer.innerHTML = "";
    if(data.pbksPlayers){
        Object.keys(data.pbksPlayers).forEach(key=>{
            pbksContainer.appendChild(createPlayerInput("pbksPlayers", key, data.pbksPlayers[key]));
        });
    }

    // 4. Load Bowlers Scorecard Data (RCB) - Uses rcb_bowlers
    const rcbBowlersContainer = document.getElementById("rcb-bowlers-scorecard");
    rcbBowlersContainer.innerHTML = "";
    if(data.rcb_bowlers){
        Object.keys(data.rcb_bowlers).forEach(key=>{
            rcbBowlersContainer.appendChild(createBowlerInput("rcb_bowlers", key, data.rcb_bowlers[key]));
        });
    }

    // 5. Load Bowlers Scorecard Data (PBKS) - Uses pbks_bowlers
    const pbksBowlersContainer = document.getElementById("pbks-bowlers-scorecard");
    pbksBowlersContainer.innerHTML = "";
    if(data.pbks_bowlers){
        Object.keys(data.pbks_bowlers).forEach(key=>{
            pbksBowlersContainer.appendChild(createBowlerInput("pbks_bowlers", key, data.pbks_bowlers[key]));
        });
    }

    // 6. Load Team Totals
    document.getElementById("rcb-score").value = data.rcbScore || "";
    document.getElementById("rcb-overs").value = data.rcbOvers || "";
    document.getElementById("pbks-score").value = data.pbksScore || "";
    document.getElementById("pbks-overs").value = data.pbksOvers || "";
    document.getElementById("match-status").value = data.status || "LIVE";
});
</script>
</body>
</html>